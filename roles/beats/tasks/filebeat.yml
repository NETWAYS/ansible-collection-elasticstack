---
- name: Install Filebeat
  package:
    name: filebeat
  when: beats_filebeat_version is not defined

- name: Install Filebeat specific version
  package:
    name: "filebeat{{ beats_filebeat_version }}"
  notify:
    - Restart Filebeat
  when:
    - beats_filebeat_version is defined
    - beats_filebeat_version != "latest"

- name: Install Filebeat latest version
  package:
    name: filebeat
    state: latest
  notify:
    - Restart Filebeat
  when:
    - beats_filebeat_version is defined
    - beats_filebeat_version == "latest"

- name: Configure Filebeat
  template:
    src: filebeat.yml.j2
    dest: /etc/filebeat/filebeat.yml
    owner: root
    group: root
    mode: 0640
  notify:
    - Restart Filebeat
  tags:
    - configuration
    - filebeat_configuration
    - beats_configuration

- name: Configure modules
  when: filebeat_modules is defined
  tags:
    - configuration
    - filebeat_configuration
    - beats_configuration
  block:

    - name: Enable modules
      command: "filebeat modules enable {{ item }}"
      args:
        creates: "/etc/filebeat/modules.d/{{ item }}.yml"
      with_items: "{{ filebeat_modules }}"

    # this is just a makeshift solution before we integrate more modules
    # or Elastic Agent
    # see https://github.com/NETWAYS/ansible-collection-elasticstack/issues/77
    # for details
    - name: Enable filesets for Filebeat system module
      lineinfile:
        path: /etc/filebeat/modules.d/system.yml
        line: '    enabled: true'
        regex: '^    enabled:'
      notify:
        - Restart Filebeat

    - name: Enable Ingest Pipelines
      command: >
        /usr/bin/filebeat setup --pipelines &&
        /usr/bin/filebeat version > /etc/filebeat/{{ item }}_pipeline_created
      args:
        creates: "/etc/filebeat/{{ item }}_pipeline_created"
      with_items: "{{ filebeat_modules }}"
      notify:
        - Restart Filebeat
      changed_when: false

- name: Start Filebeat
  service:
    name: filebeat
    state: started
    enabled: true
  when: filebeat_enable | bool
