# Ansible
#
# Rolling Upgrade of Elasticsearch with security on
# Source from: author: Jeff Steinmetz, @jeffsteinmetz; Bin Li, @holysoros
# Modifications: author: Daniel Neuberger @netways.de
# More modifications: NETWAYS Professional Services GmbH
# latest tested with Ansible 2.9 and later

---

# For now we support upgrade only for clusters with security enabled
# If you positively need support for safely upgrading clusters without security,
# feel free to open an issue at https://github.com/NETWAYS/ansible-collection-elasticstack/issues
- name: Set connection protocol to https
  ansible.builtin.set_fact:
    elasticsearch_http_protocol: "https"

- name: Check for running Elasticsearch service
  ansible.builtin.systemd:
    name: elasticsearch
  register: elasticsearch_running

- name: Update stopped services right away
  when:
    - elasticsearch_running.status.ActiveState == "inactive"
  block:
    - name: Update stopped Elasticsearch - rpm with managed repositories
      ansible.builtin.package:
        name: "{{ elasticsearch_package }}"
        enablerepo:
          - 'elastic-{% if elasticstack_variant == "oss" %}oss-{% endif %}{{ elasticstack_release }}.x'
      when:
        - ansible_os_family == "RedHat"
        - elasticstack_full_stack | bool

    - name: Update stopped Elasticsearch - deb or unmanaged repositories rpm
      ansible.builtin.package:
        name: "{{ elasticsearch_package }}"
      when:
        - ansible_os_family == "Debian" or
          not elasticstack_full_stack | bool

- name: Update single instances without extra caution
  when:
    - groups[elasticstack_elasticsearch_group_name] | length == 1
  block:
    - name: Update single instances without extra caution - deb or unmanaged repositories rpm
      ansible.builtin.package:
        name: "{{ elasticsearch_package }}"
      when:
        - ansible_os_family == "Debian" or
          not elasticstack_full_stack | bool
      notify:
        - Restart Elasticsearch

    - name: Update single instances without extra caution - rpm with managed repositories
      ansible.builtin.package:
        name: "{{ elasticsearch_package }}"
        enablerepo:
          - 'elastic-{% if elasticstack_variant == "oss" %}oss-{% endif %}{{ elasticstack_release }}.x'
      when:
        - ansible_os_family == "RedHat"
        - elasticstack_full_stack | bool
      notify:
        - Restart Elasticsearch


- name: Be careful about upgrade when Elasticsearch is running
  when:
    - elasticsearch_running.status.ActiveState == "active"
    - groups[elasticstack_elasticsearch_group_name] | length > 1
  block:

    - name: Include rolling stop
      ansible.builtin.include_tasks: elasticsearch-rolling-stop.yml

    - name: Update Elasticsearch - rpm with managed repositories
      ansible.builtin.package:
        name: "{{ elasticsearch_package }}"
        enablerepo:
          - 'elastic-{% if elasticstack_variant == "oss" %}oss-{% endif %}{{ elasticstack_release }}.x'
      when:
        - ansible_os_family == "RedHat"
        - elasticstack_full_stack | bool

    - name: Update Elasticsearch - deb or unmanaged repositories rpm
      ansible.builtin.package:
        name: "{{ elasticsearch_package }}"
      when:
        - ansible_os_family == "Debian" or
          not elasticstack_full_stack | bool

    - name: Include rolling start
      ansible.builtin.include_tasks: elasticsearch-rolling-start.yml
