---
- name: Ensure gpg exists, for signing keys
  ansible.builtin.apt:
    name:
      - gpg
      - gpg-agent
    state: present

- name: Ensure Elastic Stack key is removed (Debian legacy format)
  ansible.builtin.apt_key:
    url: "{{ elasticstack_repo_key }}"
    state: absent

# NOTE: Workaround for older ansible-core versions combined with Python 3.12 on managed nodes (e.g. Ubuntu 24.04),
# where ansible.builtin.get_url may fail with HTTPSConnection/cert_file related errors. We intentionally use curl via
# ansible.builtin.command here and will switch back to get_url once the Ansible/Python version mismatch in CI and
# supported environments is resolved.
- name: Ensure /usr/share/keyrings directory exists (Debian)
  ansible.builtin.file:
    path: /usr/share/keyrings
    state: directory
    mode: "0755"

- name: Ensure curl is installed (Debian/Ubuntu)
  ansible.builtin.apt:
    name: curl
    state: present
    update_cache: true

- name: Download Elastic Stack GPG key to temporary file
  ansible.builtin.command: curl -fsSL "{{ elasticstack_repo_key }}" -o /tmp/elasticsearch.asc
  # noqa: command-instead-of-module
  changed_when: false

- name: Stat existing key file
  ansible.builtin.stat:
    path: /usr/share/keyrings/elasticsearch.asc
    checksum_algorithm: sha256
  register: existing_key

- name: Stat downloaded temporary key file
  ansible.builtin.stat:
    path: /tmp/elasticsearch.asc
    checksum_algorithm: sha256
  register: downloaded_key

- name: Install Elastic Stack key if missing or changed
  ansible.builtin.copy:
    src: /tmp/elasticsearch.asc
    dest: /usr/share/keyrings/elasticsearch.asc
    remote_src: true
    mode: "0644"
  when: not existing_key.stat.exists or existing_key.stat.checksum != downloaded_key.stat.checksum

- name: Remove temporary key file
  ansible.builtin.file:
    path: /tmp/elasticsearch.asc
    state: absent
  changed_when: false

- name: Ensure Elastic Stack apt repo is absent (Debian legacy format)
  ansible.builtin.file:
    path: /etc/apt/sources.list.d/artifacts_elastic_co_packages_{{ item }}_x_apt.list
    state: absent
  with_items:
    - "7"
    - "oss-7"
    - "8"
    - "oss-8"

- name: Ensure Elastic Stack apt repository is configured (Debian)
  ansible.builtin.apt_repository:
    repo: deb [signed-by=/usr/share/keyrings/elasticsearch.asc] {{ elasticstack_repo_url }}/{{ elasticstack_release }}.x/apt stable main
    state: present
    filename: elasticstack
  when: elasticstack_variant == "elastic"

- name: Ensure Elastic Stack OSS apt repository is configured (Debian)
  ansible.builtin.apt_repository:
    repo: deb [signed-by=/usr/share/keyrings/elasticsearch.asc] {{ elasticstack_repo_url }}/oss-{{ elasticstack_release }}.x/apt stable main
    state: present
    filename: elasticstack
  when: elasticstack_variant == "oss"
