---

- name: Set Elasticsearch hosts if used with other roles
  set_fact:
    logstash_elasticsearch: "{{ groups['elasticsearch'] }}"
  when:
    - logstash_elasticsearch is undefined
    - groups['elasticsearch'] is defined

- name: Set Elasticsearch hosts to localhost if no other information available
  set_fact:
    logstash_elasticsearch:
      - localhost
  when:
    - logstash_elasticsearch is undefined
    - groups['elasticsearch'] is undefined

- name: Ensure Logstash is installed
  package:
    name: "logstash{{ logstash_version }}"
  when:
    - elastic_variant == "elastic"

- name: Ensure Logstash OSS is installed
  package:
    name: "logstash-oss{{ logstash_version }}"
  when:
    - elastic_variant == "oss"

- import_tasks: logstash-security.yml
  when:
    - elastic_stack_full_stack | bool
    - logstash_security | bool
    - elastic_variant == "elastic"
  tags:
    - security

- name: Configure Logstash
  template:
    src: logstash.yml.j2
    dest: /etc/logstash/logstash.yml
    owner: root
    group: root
    mode: 0644
    backup: "{{ logstash_config_backup }}"
  notify:
    - Restart Logstash
  when: logstash_manage_yaml | bool

- name: Fetch pipelines from git repositories
  block:
    - name: Create Logstash pipeline directories
      file:
        path: "/etc/logstash/conf.d/{{ logstash_pipelines[item].name }}"
        state: directory
        owner: root
        group: root
        mode: 0755
      with_items: "{{ logstash_pipelines }}"

    - name: Check out pipeline configuration
      git:
        repo: "{{ logstash_pipelines[item].source }}"
        dest: "/etc/logstash/conf.d/{{ logstash_pipelines[item].name }}"
        version: master
      with_items: "{{ logstash_pipelines }}"
      notify:
        - Restart Logstash noauto
  when:
    - logstash_pipelines is defined
    - not logstash_no_pipelines | bool

- name: Create default Elasticsearch output pipeline
  block:
    - name: Create directory for default Elasticsearch output pipeline
      file:
        path: "/etc/logstash/conf.d/ansible-forwarder"
        state: directory
        owner: root
        group: root
        mode: 0755

    - name: Create default Elasticsearch output pipeline inputs
      template:
        src: redis-input.conf.j2
        dest: "/etc/logstash/conf.d/ansible-forwarder/input.conf"
        owner: root
        group: root
        mode: 0644
      notify:
        - Restart Logstash noauto

    - name: Create default Elasticsearch output pipeline output
      template:
        src: elasticsearch-output.conf.j2
        dest: "/etc/logstash/conf.d/ansible-forwarder/output.conf"
        owner: root
        group: root
        mode: 0644
      notify:
        - Restart Logstash noauto
  when:
    - logstash_elasticsearch_output | bool
    - not logstash_no_pipelines | bool

- name: Create default Beats input pipeline
  block:
    - name: Create directory for default beats input pipeline
      file:
        path: "/etc/logstash/conf.d/ansible-input"
        state: directory
        owner: root
        group: root
        mode: 0755

    - name: Create default Beats input pipeline inputs
      template:
        src: redis-output.conf.j2
        dest: "/etc/logstash/conf.d/ansible-input/input.conf"
        owner: root
        group: root
        mode: 0644
      notify:
        - Restart Logstash noauto

    - name: Create default Beats input pipeline output
      template:
        src: beats-input.conf.j2
        dest: "/etc/logstash/conf.d/ansible-input/output.conf"
        owner: root
        group: root
        mode: 0644
      notify:
        - Restart Logstash noauto
  when:
    - logstash_beats_input | bool
    - not logstash_no_pipelines | bool

- name: Create default connector pipeline
  block:
    - name: Create directory for default connector pipeline
      file:
        path: "/etc/logstash/conf.d/ansible-connector"
        state: directory
        owner: root
        group: root
        mode: 0755

    - name: Create default connector pipeline inputs
      template:
        src: default-connector.conf.j2
        dest: "/etc/logstash/conf.d/ansible-connector/connector.conf"
        owner: root
        group: root
        mode: 0644
      notify:
        - Restart Logstash noauto
  when:
    - logstash_connector | bool
    - not logstash_no_pipelines | bool

- name: Configure Logstash pipelines
  template:
    src: pipelines.yml.j2
    dest: /etc/logstash/pipelines.yml
    owner: root
    group: root
    mode: 0644
    backup: "{{ logstash_config_backup }}"
  when:
    - logstash_manage_pipelines | bool
    - not logstash_no_pipelines | bool

- name: Install Logstash plugins
  logstash_plugin:
    state: present
    name: "{{ item }}"
  with_items: "{{ logstash_plugins }}"
  when: logstash_plugins is defined

- name: Start Logstash
  service:
    name: logstash
    state: started
    enabled: yes
  when: logstash_enable | bool
